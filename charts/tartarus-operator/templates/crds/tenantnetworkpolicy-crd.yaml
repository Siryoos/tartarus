{{- if .Values.crds.install }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: tenantnetworkpolicies.tartarus.io
  annotations:
    {{- if .Values.crds.keep }}
    "helm.sh/resource-policy": keep
    {{- end }}
  labels:
    {{- include "tartarus-operator.labels" . | nindent 4 }}
spec:
  group: tartarus.io
  names:
    kind: TenantNetworkPolicy
    listKind: TenantNetworkPolicyList
    plural: tenantnetworkpolicies
    singular: tenantnetworkpolicy
    shortNames:
      - tnp
      - tenantpolicy
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: TenantNetworkPolicy defines network policies for a tenant
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              properties:
                tenantId:
                  type: string
                  description: Tenant identifier (defaults to namespace name)
                defaultContract:
                  type: object
                  description: Default Styx network contract for this tenant
                  properties:
                    allowedCidrs:
                      type: array
                      items:
                        type: string
                      description: CIDRs that sandbox traffic is allowed to reach
                    denyPrivate:
                      type: boolean
                      description: Deny access to RFC1918 private networks
                    denyMetadata:
                      type: boolean
                      description: Deny access to cloud metadata service (169.254.169.254)
                networkPolicyRef:
                  type: object
                  description: Reference to a K8s NetworkPolicy to inherit rules from
                  properties:
                    name:
                      type: string
                      description: Name of the NetworkPolicy
                    namespace:
                      type: string
                      description: Namespace of the NetworkPolicy (defaults to same namespace)
            status:
              type: object
              properties:
                ready:
                  type: boolean
                  description: Whether the policy is ready
                message:
                  type: string
                  description: Status message
                lastApplied:
                  type: string
                  format: date-time
                  description: Last time the policy was applied
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                    required:
                      - type
                      - status
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Ready
          type: boolean
          jsonPath: .status.ready
        - name: Tenant
          type: string
          jsonPath: .spec.tenantId
        - name: DenyPrivate
          type: boolean
          jsonPath: .spec.defaultContract.denyPrivate
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
{{- end }}
